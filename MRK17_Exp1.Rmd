---
title: "Analysis of MRK17_Exp1"
author: "Reinhold Kliegl"
date: "2019-12-20 (last revised: `r format(Sys.time())`)"
output: 
    html_document:
        toc: yes
        toc_depth: 2
        number_sections: yes
        toc_float: FALSE
editor_options: 
  chunk_output_type: console
---


```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
```

# Background

This semantic-priming experiment was reported in Masson, Rabe, & Kliegl (2017, Exp. 1, Memory & Cognition). It is a direct replication of an experiment reported in Masson & Kliegl (2013, Exp. 1, JEPLMC). Following a prime word a related or unrelated high- or low-frequency target word or a nonword was presented in clear or dim font. The subject's task was to decide as quickly as possible whether the target was a word or a nonword, that is subjects performed a lexical decision task (LDT). The reaction time and the accuracy of the response were recorded. Only correct reaction times to words are included. After filtering there were 16,409 observations recorded from 73 subjects and 240 items.

# Codebook

The data (variables and observations) used by Masson et al. (2017) are available in file `MRK17_Exp1.RDS`

|Variable | Description|
|---------|----------- |
|Subj     | Subject identifier |
|Item     | Target (non-)word  |    
|trial    | Trial number |
|F        | Target frequency is _high_  or _low_ |
|P        | Prime is _related_ or _unrelated_ to target |
|Q        | Target quality is _clear_ or _degraded_   |
|lQ       | Last-trial target quality is _clear_ or _degraded_  |
|lT       | Last-trail target requires _word_ or _nonword_ response |
|rt       | Reaction time [ms] |

`lagQlty` and `lagTrgt` refer to experimental conditions in the last trial. 

Corresponding indicator variables (-1/+1):


# Read data and add transformations of variables

```{r}
dat <- readRDS("MRK17_Exp1.Rds")

# set contrasts 
contrasts(dat$F)  <- contr.sum(2)
contrasts(dat$P)  <- contr.sum(2)
contrasts(dat$Q)  <- contr.sum(2)
contrasts(dat$lQ) <- contr.sum(2)
contrasts(dat$lT) <- contr.sum(2)

# Letter codes for factors, converted to indicator variables (numeric -> lower case)
mm <- model.matrix(~ 1 + F*P*Q*lQ*lT, data=dat)
dat$f  <- mm[,2]
dat$p  <- mm[,3]
dat$q  <- mm[,4]
dat$lq <- mm[,5]
dat$lf <- mm[,6]

# reciprocal rt 
dat$rrt <- -1000/dat$rt  # justified by boxcox for LDT

# centered trial
dat$trial.c <- dat$trial - 240 # intercept is last trial of first half of session
```

# A parsimonious LMM


## Replication
This LMM specification is identical to the final LMM in Masson & Kliegl (2013, Table 1) as well as Masson, Rabe, and Kliegl (2017, Figure 2).

```{r m_prsm, cache=TRUE}
prsmLMM <- lmer(rrt ~ 1 + F*P*Q*lQ*lT + (1+q | Subj) + (0+lq | Subj) + (1 | Item) + (0+p | Item), 
                      data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

summary(rePCA(prsmLMM))
VarCorr(prsmLMM)

print(summary(prsmLMM), corr=FALSE)
```

## A priori F x P interactions 

### Wilkinson & Rogers (1973) syntax

The theoretical interactions relate to the interaction of `F` and `P`. We test this interaction in each cells of the _outer_ design crossing lQ x lT trial histories.

```{r}
n_in_cLMM <- lmer(rrt ~ 1 + ((lQ*lT)/(F*P))*Q + (1+q | Subj) + (0+lq | Subj) + (1 | Item) + (0+p | Item), 
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

summary(rePCA(n_in_cLMM))
VarCorr(n_in_cLMM)

print(summary(n_in_cLMM), corr=FALSE)
```

### Custom contrasts (Masson & Kliegl, 2013)


```{r}
# Is the F x P interaction oppositely significant within levels of Lag_Target by LagQuality? YES! see m1
dat$WLFP <- factor(paste(substr(dat$W, 1, 1), substr(dat$L, 1, 1), substr(dat$F, 1, 1), substr(dat$P, 1, 1), sep="_") )

# ... re-order alphabetically sorted levels to correspond to factorial design
d$WLFP <- factor(d$WLFP, levels=c(levels(d$WLFP)[9:16], levels(d$WLFP)[1:8]) )

# Setup matrix for f x p as nested within levels of w x l
cmat   <- matrix(c(            -1/8, -1/8, -1/8, -1/8, -1/8, -1/8, -1/8, -1/8, +1/8, +1/8, +1/8, +1/8, +1/8, +1/8, +1/8, +1/8,
                               -1/8, -1/8, -1/8, -1/8, +1/8, +1/8, +1/8, +1/8, -1/8, -1/8, -1/8, -1/8, +1/8, +1/8, +1/8, +1/8,
                               +1/8, +1/8, +1/8, +1/8, -1/8, -1/8, -1/8, -1/8, -1/8, -1/8, -1/8, -1/8, +1/8, +1/8, +1/8, +1/8,
                               -1/2, -1/2, +1/2, +1/2,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
                               -1/2, +1/2, -1/2, +1/2,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
                               +1/2, -1/2, -1/2, +1/2,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
                                  0,    0,    0,    0, -1/2, -1/2, +1/2, +1/2,    0,    0,    0,    0,    0,    0,    0,    0,
                                  0,    0,    0,    0, -1/2, +1/2, -1/2, +1/2,    0,    0,    0,    0,    0,    0,    0,    0,
                                  0,    0,    0,    0, +1/2, -1/2, -1/2, +1/2,    0,    0,    0,    0,    0,    0,    0,    0,
                                  0,    0,    0,    0,    0,    0,    0,    0, -1/2, -1/2, +1/2, +1/2,    0,    0,    0,    0,
                                  0,    0,    0,    0,    0,    0,    0,    0, -1/2, +1/2, -1/2, +1/2,    0,    0,    0,    0,
                                  0,    0,    0,    0,    0,    0,    0,    0, +1/2, -1/2, -1/2, +1/2,    0,    0,    0,    0,
                                  0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, -1/2, -1/2, +1/2, +1/2,
                                  0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, -1/2, +1/2, -1/2, +1/2,
                                  0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, +1/2, -1/2, -1/2, +1/2 ), 16, 15)

cmat.i <- fractions(t(ginv(cmat)))
rownames(cmat.i) <- levels(d$WLFP)
colnames(cmat.i) <- c(".lW", ".lQ", ".lW_lQ", ".f1", ".p1", ".fp1", ".f2", ".p2", ".fp2", ".f3", ".p3", ".fp3", ".f4", ".p4", ".fp4")
(contrasts(d$WLFP) <- cmat.i)

print(m1 <- lmer(rrt ~ 1 + WLFP*Q + (1 | id) + (1 | st), data=d), cor=FALSE)

# ... ... check for equality of logLik of m0 and m1
anova(m0, m1)


```

# Appendix

```{r}
sessionInfo()
```

